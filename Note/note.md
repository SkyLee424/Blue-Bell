# user_id ç›¸å…³ 

- ç›´æ¥ä½¿ç”¨ä¸»é”® id ä½œä¸ºç”¨æˆ· idï¼Œåœ¨åˆ†åº“åˆ†è¡¨æ—¶ä¸å‹å¥½
- å¦‚æœä½¿ç”¨ uuidï¼Œæ²¡æœ‰è§„å¾‹ï¼Œåœ¨æ’åºçš„æ—¶å€™ä¸å‹å¥½

å› æ­¤ä½¿ç”¨ **é›ªèŠ±ç®—æ³•** ç”Ÿæˆåˆ†å¸ƒå¼ ID

## åˆ†å¸ƒå¼ ID ç‰¹ç‚¹

- å…¨å±€å”¯â¼€æ€§ï¼šä¸èƒ½å‡ºç°æœ‰é‡å¤çš„IDæ ‡è¯†ï¼Œè¿™æ˜¯åŸºæœ¬è¦æ±‚ã€‚
- é€’å¢æ€§ï¼šä¿è¯ç”Ÿæˆçš„ ID æ˜¯é€’å¢çš„
- é«˜å¯ç”¨æ€§
- é«˜æ€§èƒ½æ€§

## é›ªèŠ±ç®—æ³•

![](2023-10-15-16-49-39.png)

1. ç¬¬ä¸€ä½ å ç”¨1bitï¼Œå…¶å€¼å§‹ç»ˆæ˜¯0ï¼Œæ²¡æœ‰å®é™…ä½œç”¨ã€‚
2. æ—¶é—®æˆ³ å ç”¨41bitï¼Œ å•ä½ä¸ºæ¯«ç§’ï¼Œæ€»å…±å¯ä»¥å®¹çº³çº¦69å¹´çš„æ—¶é—´ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬çš„æ—¶é—´æ¯«ç§’è®¡æ•°ä¸ä¼šçœŸçš„ä»1970å¹´å¼€å§‹è®°ï¼Œé‚£æ ·æˆ‘ä»¬çš„ç³»ç»Ÿè·‘åˆ° 2039/9/7 23:47ï¼š35 å°±ä¸èƒ½ç”¨äº†ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ—¶é—´æˆ³åªæ˜¯ç›¸å¯¹åƒæŸä¸ªæ—¶é—®çš„å¢é‡ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„ç³»ç»Ÿä¸Šçº¿æ˜¯2020-07-01ï¼Œé‚£ä¹ˆæˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠè¿™ä¸ªtimestampå½“ä½œæ˜¯ä» 2020-07-01 00:00ï¼š00.000 çš„åç§»é‡ã€‚
3. å·¥ä½œæœºå™¨id å ç”¨10bitï¼Œå…¶ä¸­é«˜ä½5bitæ˜¯æ•°æ®ä¸­å¿ƒ1Dï¼Œä½ä½5bitæ˜¯å·¥ä½œèŠ‚ç‚¹1Dï¼Œæœ€å¤šå¯ä»¥å®¹çº³1024ä¸ªèŠ‚
ç‚¹ã€‚
4. åºåˆ—å· å ç”¨12bitï¼Œ ç”¨æ¥è®°å½•åŒæ¯«ç§’å†…äº§ç”Ÿçš„ä¸åŒidã€‚æ¯ä¸ªèŠ‚ç‚¹æ¯æ¯«ç§’0å¼€å§‹ä¸æ–­ç´¯åŠ ï¼Œæœ€å¤šå¯ä»¥ç´¯åŠ åˆ°4095ï¼ŒåŒä¸€æ¯«ç§’ä¸€å…±å¯ä»¥äº§ç”Ÿ4096ä¸ª1Dã€‚

## å‰ç«¯ ID å¤±çœŸé—®é¢˜

Javascript èƒ½å¤Ÿè¡¨è¾¾çš„æœ€å¤§çš„æ•°å­—ä¸º $2^53 - 1$

ä½†æ˜¯éšç€æ—¶é—´çš„å¢é•¿ï¼Œæˆ‘ä»¬ç”Ÿæˆçš„ user_idï¼ˆint64ï¼‰ æœ€ç»ˆå°†ä¼šè¶…è¿‡è¯¥å€¼ï¼Œå¦‚æœå°†è¯¥ id ä¼ ç»™å‰ç«¯ï¼Œæ•°æ®å°†ä¼šæº¢å‡º

è§£å†³æ–¹æ³•ï¼š

åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ– json æ•°æ®æ—¶ï¼Œå°† ID å­—æ®µæŒ‰ç…§å­—ç¬¦ä¸²çš„æ–¹å¼åºåˆ—åŒ–å’Œååºåˆ—åŒ–

> å°æŠ€å·§ï¼šå¯ä»¥åœ¨å­—æ®µçš„ json Tag åŠ ä¸Š `string` æŒ‡å®šï¼ˆåï¼‰åºåˆ—åŒ–æ–¹å¼
> 
> ```go
> ID       int64  `json:"id,string"`
> ```

# Token ç›¸å…³

<!-- åªä½¿ç”¨ access_token çš„é—®é¢˜ -->
<!-- å¼•å…¥ refresh_token -->
<!-- æµç¨‹ -->

# é™æµ

## æ¼æ¡¶ç®—æ³•

æ¼æ¡¶ç®—æ³•ç”¨äº **æ§åˆ¶** ä»¥å›ºå®šé€Ÿç‡è¿›å…¥çš„æ•°æ®æµä»¥åŒ¹é…äº‹å…ˆè§„å®šçš„ **å³°å€¼æµé‡** ï¼Œé˜²æ­¢çªå‘æ•°æ®æµé‡å¯¹ç½‘ç»œè®¾å¤‡å’Œå¸¦å®½çš„å½±å“ã€‚

æ¼æ¡¶ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³ç±»ä¼¼äºä¸€ä¸ªæœ‰é™å®¹é‡çš„æ°´æ¡¶ï¼Œæ•°æ®åŒ…å°±åƒæ°´æ»´ä¸€æ ·è¿›å…¥æ°´æ¡¶ã€‚å¦‚æœæ°´æ»´çš„åˆ°æ¥é€Ÿåº¦è¶…è¿‡äº†æ°´æ¡¶çš„å®¹é‡ï¼Œå¤šä½™çš„æ°´æ»´å°±ä¼šè¢« **ä¸¢å¼ƒ** æˆ– **æ’é˜Ÿç­‰å¾…** ã€‚è¿™æ ·å¯ä»¥é™åˆ¶æµé‡çš„å³°å€¼ï¼Œä½¿å…¶åŒ€é€Ÿåœ°è¾“å‡ºï¼Œä»è€Œé¿å…ç½‘ç»œæ‹¥å¡å’Œçªå‘æ•°æ®åŒ…ã€‚

æ¼æ¡¶ç®—æ³•çš„ä¸»è¦ç‰¹ç‚¹å’Œå·¥ä½œåŸç†å¦‚ä¸‹ï¼š

1. **å›ºå®šé€Ÿç‡è¾“å‡ºï¼š** ç®—æ³•é€šè¿‡ä¸€ä¸ªå›ºå®šçš„é€Ÿç‡æ¥è¾“å‡ºæ•°æ®ï¼Œæ— è®ºè¾“å…¥æ•°æ®çš„é€Ÿç‡å¦‚ä½•ï¼Œè¾“å‡ºé€Ÿç‡éƒ½æ˜¯æ’å®šçš„ã€‚

2. **æœ‰é™å®¹é‡çš„ç¼“å†²åŒºï¼š** ç®—æ³•ä½¿ç”¨ä¸€ä¸ªæœ‰é™å®¹é‡çš„ç¼“å†²åŒºï¼ˆå³æ°´æ¡¶ï¼‰ï¼Œå½“è¾“å…¥æ•°æ®åˆ°è¾¾æ—¶ï¼Œä¼šæ”¾å…¥ç¼“å†²åŒºã€‚å¦‚æœç¼“å†²åŒºå·²æ»¡ï¼Œå¤šä½™çš„æ•°æ®åŒ…å°†è¢«ä¸¢å¼ƒã€‚

3. **æŒ‰é¡ºåºè¾“å‡ºï¼š** ç¼“å†²åŒºä¸­çš„æ•°æ®åŒ…æŒ‰ç…§å®ƒä»¬çš„åˆ°è¾¾é¡ºåºè¾“å‡ºï¼Œè€Œä¸ä¼šå› ä¸ºæŸäº›æ•°æ®åŒ…çš„çªå‘åˆ°æ¥è€Œä¼˜å…ˆè¾“å‡ºã€‚

4. **é€Ÿç‡æ§åˆ¶ï¼š** æ¼æ¡¶ç®—æ³•é€šè¿‡æ§åˆ¶è¾“å…¥æ•°æ®çš„é€Ÿç‡ï¼Œä»¥ç¡®ä¿è¾“å‡ºæ•°æ®çš„é€Ÿç‡ä¸ä¼šè¶…è¿‡é¢„å®šçš„é€Ÿç‡ã€‚

æ¼æ¡¶ç®—æ³•åœ¨æŸäº›å®æ—¶æ€§è¦æ±‚é«˜çš„åº”ç”¨ä¸­å¯èƒ½ä¸é€‚ç”¨ï¼Œä¾‹å¦‚ç§’æ€ç³»ç»Ÿçš„é™æµï¼Œå¦‚æœæ­¤æ—¶æ²¡æœ‰å¯ç”¨çš„æ°´æ»´ï¼Œå°†ä¼š **é˜»å¡**ï¼Œè€Œå®¢æˆ·ç«¯å¹¶ä¸å¸Œæœ›æœåŠ¡ç«¯é˜»å¡è¯·æ±‚ï¼Œè€Œæ˜¯è¾ƒå¿«ï¼ˆç«‹å³ï¼‰è¿”å›ç§’æ€ç»“æœ

### ratelimit åº“

[Go è¯­è¨€ç”¨å¾—æ¯”è¾ƒå¤šçš„ï¼ŒåŸºäºæ¼æ¡¶ç®—æ³•å®ç°çš„é™æµç­–ç•¥çš„å¼€æºåº“](https://github.com/uber-go/ratelimit/)

ä½¿ç”¨è¯¥åº“ï¼Œä¸º gin æ¡†æ¶ç¼–å†™é™æµä¸­é—´ä»¶ï¼š

```go
func RateLimit2(rate int) gin.HandlerFunc {
	bucket := ratelimit2.New(rate) æ¯ç§’äº§ç”Ÿ rate ä¸ªæ°´æ»´ï¼Œä¹Ÿå°±æ˜¯æœ€å¤šå…è®¸ rate ä¸ªè¯·æ±‚
	return func(ctx *gin.Context) {
		bucket.Take() è¿”å›ä¸‹ä¸€æ¬¡æ»´æ°´çš„æ—¶é—´
		ctx.Next()
	}
}
```

ä¸»è¦æ¥çœ‹ä¸€ä¸‹ Take æ–¹æ³•ï¼š

```go
Take ä¼šé˜»å¡ç¡®ä¿ä¸¤æ¬¡è¯·æ±‚ä¹‹é—´çš„æ—¶é—´èµ°å®Œ
Take è°ƒç”¨å¹³å‡æ•°ä¸º time.Second/rate.
func (t *limiter) Take() time.Time {
	t.Lock()
	defer t.Unlock()

	now := t.clock.Now()

	å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¯·æ±‚å°±ç›´æ¥æ”¾è¡Œ
	if t.last.IsZero() {
		t.last = now
		return t.last
	}

	sleepFor æ ¹æ® perRequest å’Œä¸Šä¸€æ¬¡è¯·æ±‚çš„æ—¶åˆ»è®¡ç®—åº”è¯¥sleepçš„æ—¶é—´
	ç”±äºæ¯æ¬¡è¯·æ±‚é—´éš”çš„æ—¶é—´å¯èƒ½ä¼šè¶…è¿‡perRequest, æ‰€ä»¥è¿™ä¸ªæ•°å­—å¯èƒ½ä¸ºè´Ÿæ•°ï¼Œå¹¶åœ¨å¤šä¸ªè¯·æ±‚ä¹‹é—´ç´¯åŠ 
	t.sleepFor += t.perRequest - now.Sub(t.last)

	æˆ‘ä»¬ä¸åº”è¯¥è®©sleepForè´Ÿçš„å¤ªå¤šï¼Œå› ä¸ºè¿™æ„å‘³ç€ä¸€ä¸ªæœåŠ¡åœ¨çŸ­æ—¶é—´å†…æ…¢äº†å¾ˆå¤šéšåä¼šå¾—åˆ°æ›´é«˜çš„RPSã€‚
	if t.sleepFor < t.maxSlack {
		t.sleepFor = t.maxSlack
	}

	å¦‚æœ sleepFor æ˜¯æ­£å€¼é‚£ä¹ˆå°± sleep
	if t.sleepFor > 0 {
		t.clock.Sleep(t.sleepFor)
		t.last = now.Add(t.sleepFor)
		t.sleepFor = 0
	} else {
		t.last = now
	}

	return t.last
}
```

å¯ä»¥å‘ç°ï¼Œå¦‚æœ RPS å¤§äºç»™å®šçš„ rateï¼Œåœ¨ Take å†…éƒ¨æ˜¯ä¼šé˜»å¡å½“å‰çš„ goroutine çš„

å½“å‰çš„ goroutine æ²¡æœ‰åŠæ³•åœ¨ä¸èƒ½ç«‹å³è·å–æ°´æ»´çš„æƒ…å†µåšå‡ºå“åº”ï¼Œè€Œæ˜¯å¿…é¡»ç­‰å¾…

å› æ­¤ï¼Œè¯¥æ–¹æ³•ä¸é€‚ç”¨äºå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯

## ä»¤ç‰Œæ¡¶ç®—æ³•

ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucket Algorithmï¼‰ä¹Ÿæ˜¯ç”¨äºæ§åˆ¶æ•°æ®åŒ…çš„ä¼ è¾“é€Ÿç‡ã€‚ä¸æ¼æ¡¶ç®—æ³•ä¸åŒï¼Œä»¤ç‰Œæ¡¶ç®—æ³•æ”¯æŒçªå‘æµé‡çš„å¿«é€Ÿå¤„ç†

ä»¤ç‰Œæ¡¶ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³ç±»ä¼¼äºä¸€ä¸ªæ¡¶ï¼Œæ¡¶å†…åŒ…å«äº†ä¸€å®šæ•°é‡çš„ä»¤ç‰Œï¼Œæ¯ä¸ªä»¤ç‰Œä»£è¡¨ä¸€ä¸ªæ•°æ®åŒ…ã€‚è¿™äº›ä»¤ç‰Œä»¥å›ºå®šé€Ÿç‡è¢«æ”¾å…¥æ¡¶ä¸­ã€‚å½“æ•°æ®åŒ…åˆ°è¾¾æ—¶ï¼Œéœ€è¦ä»æ¡¶ä¸­è·å–ä¸€ä¸ªä»¤ç‰Œæ‰èƒ½è¢«å‘é€ã€‚å¦‚æœæ¡¶ä¸­æ²¡æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œï¼Œæ•°æ®åŒ…å°†ç­‰å¾…ï¼Œç›´åˆ°æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œå¯ç”¨ã€‚

ä»¤ç‰Œæ¡¶ç®—æ³•çš„ä¸»è¦ç‰¹ç‚¹å’Œå·¥ä½œåŸç†å¦‚ä¸‹ï¼š

1. **ä»¤ç‰Œç”Ÿæˆé€Ÿç‡ï¼š** ä»¤ç‰Œæ¡¶ç®—æ³•ä»¥å›ºå®šé€Ÿç‡ç”Ÿæˆä»¤ç‰Œå¹¶æ”¾å…¥ä»¤ç‰Œæ¡¶ä¸­ã€‚ç”Ÿæˆé€Ÿç‡å¯ä»¥è¡¨ç¤ºä¸ºâ€œn ä»¤ç‰Œ/ç§’â€ã€‚

2. **ä»¤ç‰Œæ¶ˆè€—é€Ÿç‡ï¼š** æ¯ä¸ªæ•°æ®åŒ…å‘é€å‰éœ€è¦è·å–ä¸€ä¸ªä»¤ç‰Œã€‚å› æ­¤ï¼Œæ•°æ®åŒ…çš„å‘é€é€Ÿç‡å—åˆ°ä»¤ç‰Œç”Ÿæˆé€Ÿç‡çš„é™åˆ¶ã€‚

3. **ä»¤ç‰Œæ¡¶å®¹é‡ï¼š** ä»¤ç‰Œæ¡¶æœ‰ä¸€ä¸ªæœ€å¤§å®¹é‡ï¼Œé™åˆ¶äº†åŒæ—¶å¯ç”¨çš„ä»¤ç‰Œæ•°é‡ã€‚å¦‚æœä»¤ç‰Œæ¡¶å·²æ»¡ï¼Œç”Ÿæˆçš„ä»¤ç‰Œå°†è¢«ä¸¢å¼ƒã€‚

4. **æŒ‰éœ€å‘é€ï¼š** å½“æ•°æ®åŒ…åˆ°è¾¾æ—¶ï¼Œå¦‚æœæ¡¶ä¸­æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œï¼Œæ•°æ®åŒ…å°†è¢«å‘é€å¹¶ä¸”ç›¸åº”æ•°é‡çš„ä»¤ç‰Œå°†è¢«æ¶ˆè€—ã€‚å¦‚æœä»¤ç‰Œæ¡¶ä¸ºç©ºï¼Œæ•°æ®åŒ…å°†ç­‰å¾…ï¼Œç›´åˆ°æœ‰è¶³å¤Ÿçš„ä»¤ç‰Œå¯ç”¨ã€‚

ä»¤ç‰Œæ¡¶ç®—æ³•çš„ä¼˜ç‚¹æ˜¯èƒ½å¤Ÿä»¥å›ºå®šçš„é€Ÿç‡å‘é€æ•°æ®åŒ…ï¼ŒåŒæ—¶å…·æœ‰ä¸€å®šçš„å¼¹æ€§ï¼Œ**å…è®¸çŸ­æœŸçªå‘æµé‡**ã€‚å®ƒè¿˜å¯ä»¥å¹³æ»‘ä¼ è¾“é€Ÿç‡ï¼Œé¿å…ç½‘ç»œæ‹¥å¡ã€‚

### ratelimit åº“

[åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•å®ç°çš„ ratelimit åº“](https://github.com/juju/ratelimit)

#### åˆ›å»º

```go
åˆ›å»ºæŒ‡å®šå¡«å……é€Ÿç‡å’Œå®¹é‡å¤§å°çš„ä»¤ç‰Œæ¡¶
func NewBucket(fillInterval time.Duration, capacity int64) *Bucket
åˆ›å»ºæŒ‡å®šå¡«å……é€Ÿç‡ã€å®¹é‡å¤§å°å’Œæ¯æ¬¡å¡«å……çš„ä»¤ç‰Œæ•°çš„ä»¤ç‰Œæ¡¶
func NewBucketWithQuantum(fillInterval time.Duration, capacity, quantum int64) *Bucket
åˆ›å»ºå¡«å……é€Ÿåº¦ä¸ºæŒ‡å®šé€Ÿç‡å’Œå®¹é‡å¤§å°çš„ä»¤ç‰Œæ¡¶
NewBucketWithRate(0.1, 200) è¡¨ç¤ºæ¯ç§’å¡«å……20ä¸ªä»¤ç‰Œ
func NewBucketWithRate(rate float64, capacity int64) *Bucket

```

#### è·å–ä»¤ç‰Œ

```go
å–tokenï¼ˆéé˜»å¡ï¼‰
func (tb *Bucket) Take(count int64) time.Duration
func (tb *Bucket) TakeAvailable(count int64) int64

æœ€å¤šç­‰maxWaitæ—¶é—´å–token
func (tb *Bucket) TakeMaxDuration(count int64, maxWait time.Duration) (time.Duration, bool)

å–tokenï¼ˆé˜»å¡ï¼‰
func (tb *Bucket) Wait(count int64)
func (tb *Bucket) WaitMaxDuration(count int64, maxWait time.Duration) bool
```

- Take æ–¹æ³•è¿”å›å– count ä¸ªä»¤ç‰Œï¼Œcaller åº”è¯¥ç­‰å¾…çš„æ—¶é—´
- TakeAvailable æ–¹æ³•è¿”å›å– count ä¸ªä»¤ç‰Œï¼Œå®é™…å–å¾—çš„ä»¤ç‰Œçš„ä¸ªæ•°

#### ç¤ºä¾‹

åŒæ ·çš„ï¼šä½¿ç”¨è¯¥åº“ï¼Œä¸º gin æ¡†æ¶ç¼–å†™é™æµä¸­é—´ä»¶ï¼š

```go
é™æµä¸­é—´ä»¶ï¼Œå¦‚æœæ²¡æœ‰å¯ç”¨ä»¤ç‰Œï¼Œç›´æ¥æ‹’ç»è¯·æ±‚
//
rateï¼šä»¤ç‰Œç”Ÿæˆé€Ÿç‡ï¼Œä¾‹å¦‚ï¼Œrate = 0.1ï¼Œä»£è¡¨æ¯ç§’ç”Ÿæˆ 0.1 * capacity ä¸ªä»¤ç‰Œ
//
capacityï¼šä»¤ç‰Œæ¡¶å¤§å°
func RateLimit(rate float64, capacity int64) gin.HandlerFunc {
	bucket := ratelimit.NewBucketWithRate(rate, capacity)
	return func(ctx *gin.Context) {
		å¦‚æœå–å¾—çš„ä»¤ç‰Œæ•°é‡ä¸æ€»çš„ä»¤ç‰Œæ•°ä¸ç›¸ç­‰ï¼Œè¯´æ˜ä»¤ç‰Œæ•°ä¸å¤Ÿï¼Œé™æµ
		if bucket.TakeAvailable(1) != 1 {
			ç›´æ¥æ‹’ç»è¯·æ±‚
			controller.ResponseError(ctx, controller.CodeServerBusy)
			ctx.Abort()
			return
		}
		ctx.Next()
	}
}
```

#### Take æ–¹æ³•è¯¦è§£

å…ˆæ¥çœ‹çœ‹æºç 

```go
func (tb *Bucket) take(now time.Time, count int64, maxWait time.Duration) (time.Duration, bool) {
	if count <= 0 {
		return 0, true
	}

	tick := tb.currentTick(now)
	tb.adjustavailableTokens(tick) æ ¹æ®å½“å‰æ—¶é—´ï¼Œæ›´æ–°ä»¤ç‰Œæ¡¶ä¸­ï¼Œå¯ç”¨çš„ä»¤ç‰Œæ•°
	avail := tb.availableTokens - count
	if avail >= 0 { å¦‚æœå¯ç”¨ä»¤ç‰Œæ•°å¤§äº countï¼Œç›´æ¥è¿”å›
		tb.availableTokens = avail
		return 0, true
	}

	endTick ä¿å­˜äº†å¯ä»¥è·å– count ä¸ªä»¤ç‰Œï¼Œæœ€ç»ˆçš„æ—¶é—´
	endTick := tick + (-avail+tb.quantum-1)/tb.quantum
	endTime := tb.startTime.Add(time.Duration(endTick) * tb.fillInterval)
	waitTime := endTime.Sub(now) caller åº”è¯¥ç­‰å¾… waitTime æ‰èƒ½è·å– count ä¸ªä»¤ç‰Œ
	if waitTime > maxWait {      è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´
		return 0, false
	}
	tb.availableTokens = avail ä¿®æ”¹ä»¤ç‰Œæ¡¶ä¸­ï¼Œå¯ç”¨çš„ä»¤ç‰Œæ•°ï¼Œè¿™é‡Œå¯èƒ½ä¸ºè´Ÿå€¼
	return waitTime, true
}
```

Take å’Œ TakeMaxDuration éƒ½ä¼šè°ƒç”¨ take æ–¹æ³•

å¯¹äºä¸€äº›å³ä½¿æœåŠ¡å™¨å¤„äºè¾ƒé«˜è´Ÿè½½ï¼Œä¹Ÿè¦ç»§ç»­æ‰§è¡Œçš„ä»»åŠ¡ï¼ˆ**é«˜ä¼˜å…ˆçº§ä»»åŠ¡**ï¼‰ï¼Œä½¿ç”¨ Take æ–¹æ³•ï¼Œ**å¯ä»¥ã€Œæ¬ ã€ä¸€äº›ä»¤ç‰Œ**ï¼ˆä¼šå¯¼è‡´å¯ç”¨ä»¤ç‰Œæ•°ä¸ºè´Ÿï¼‰

é«˜ä¼˜å…ˆçº§ä»»åŠ¡å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œè€Œè¾ƒä½ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œç­‰å¾…æ—¶é—´ä¼šæ›´é•¿ï¼Œæˆ–è€…ç›´æ¥æ‹’ç»å®¢æˆ·ç«¯çš„è¯·æ±‚

ä¸‹é¢æ˜¯ä¸€ä¸ªé’ˆå¯¹ä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè®¾ç½®ä¸åŒé™æµä¸­é—´ä»¶çš„ç¤ºä¾‹ï¼š

```go
ä¸¤ä¸ªä¸­é—´ä»¶ä½¿ç”¨åŒä¸€ä¸ªæ¡¶

var bucket = ratelimit.NewBucketWithRate(0.1, 5000)

func RateLimitForHighPriorityTask() gin.HandlerFunc  {
	return func(ctx *gin.Context) {
		bucket.Take(1) é«˜ä¼˜å…ˆçº§ä»»åŠ¡ç›´æ¥å–ï¼Œä¸ç”¨è€ƒè™‘é™æµï¼Œä¿è¯é«˜å¯ç”¨æ€§
		ctx.Next()
	}
}

func RateLimitForLowPriorityTask() gin.HandlerFunc  {
	return func(ctx *gin.Context) {
		if waitTime := bucket.Take(1); waitTime != 0 { ä½ä¼˜å…ˆçº§ä»»åŠ¡å–ä»¤ç‰Œï¼Œè€ƒè™‘é™æµ
			ç­‰å¾…
			time.Sleep(waitTime)
		} 
		ctx.Next()
	}
}
```

### ä¸ºä»€ä¹ˆæ”¯æŒçªå‘æµé‡çš„å¤„ç†

ä»¤ç‰Œæ¡¶ç®—æ³•å†…éƒ¨è®°å½•äº†

- å¯ç”¨çš„ä»¤ç‰Œæ•°çš„æ•°é‡
- ä»¤ç‰Œäº§ç”Ÿé€Ÿç‡

å¦‚æœæœ‰çªå‘æµé‡ï¼Œåªè¦æœ‰å¯ç”¨çš„ä»¤ç‰Œï¼Œå°±å¯ä»¥ç»§ç»­å“åº”

è€Œæ¼æ¡¶ç®—æ³•åªè®°å½•äº†æ°´æ»´äº§ç”Ÿçš„é€Ÿç‡ï¼Œæ¯ç§’æœ€å¤šæ¥å—çš„è¯·æ±‚æ˜¯å›ºå®šçš„

ä¾‹å¦‚ï¼Œå‡è®¾ä¸¤ç§ç®—æ³•çš„äº§ç”Ÿé€Ÿç‡éƒ½ä¸º 1000

ä½†ä»¤ç‰Œæ¡¶çš„å®¹é‡ä¸º $10^7$

- å¯¹äºä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå¦‚æœ server è´Ÿè½½ä¸é«˜ï¼Œå¯ç”¨ä»¤ç‰Œè‚¯å®šæ˜¯è¿œå¤§äº 1000 çš„ï¼Œé¢å¯¹çªå‘æµé‡ï¼ŒRPS ä¹Ÿå°±è¿œå¤§äº 1000 äº†
- å¯¹äºæ¼æ¡¶ç®—æ³•ï¼Œå³ä½¿ server è´Ÿè½½ä¸é«˜ï¼ŒRPS æœ€é«˜ä¹Ÿå°± 1000

ä¸ªäººæ„Ÿè§‰ï¼Œä»¤ç‰Œæ¡¶ç®—æ³•æ”¯æŒçªå‘æµé‡çš„å¤„ç†çš„æ ¸å¿ƒå°±æ˜¯ï¼šå°†é€Ÿç‡å’Œå®¹é‡ **è§£è€¦åˆ**

### ä¼˜ç‚¹

- æ”¯æŒçŸ­æœŸçªå‘æµé‡çš„å¤„ç†
- æ”¯æŒä¼˜å…ˆçº§åŒºåˆ†

# æ€§èƒ½è°ƒä¼˜

> Goè¯­è¨€é¡¹ç›®ä¸­çš„æ€§èƒ½ä¼˜åŒ–ä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
> 
> - CPU profileï¼šæŠ¥å‘Šç¨‹åºçš„ CPU ä½¿ç”¨æƒ…å†µï¼ŒæŒ‰ç…§ä¸€å®šé¢‘ç‡å»é‡‡é›†åº”ç”¨ç¨‹åºåœ¨ CPU å’Œå¯„å­˜å™¨ä¸Šé¢çš„æ•°æ®
> - Memory Profileï¼ˆHeap Profileï¼‰ï¼šæŠ¥å‘Šç¨‹åºçš„å†…å­˜ä½¿ç”¨æƒ…å†µ
> - Block Profilingï¼šæŠ¥å‘Š goroutines ä¸åœ¨è¿è¡ŒçŠ¶æ€çš„æƒ…å†µï¼Œå¯ä»¥ç”¨æ¥åˆ†æå’ŒæŸ¥æ‰¾æ­»é”ç­‰æ€§èƒ½ç“¶é¢ˆ
> - Goroutine Profilingï¼šæŠ¥å‘Š goroutines çš„ä½¿ç”¨æƒ…å†µï¼Œæœ‰å“ªäº› goroutineï¼Œå®ƒä»¬çš„è°ƒç”¨å…³ç³»æ˜¯æ€æ ·çš„

## é‡‡é›†æ•°æ®

go å†…ç½®äº†ä¸¤ä¸ªåº“ç”¨æ¥é‡‡é›†æ•°æ®ï¼š

- runtime/pprof
- net/http/pprof

### å·¥å…·å‹

å·¥å…·å‹åº”ç”¨å¯ä»¥ä½¿ç”¨ `runtime/pprof` é‡‡é›†æ•°æ®

```go
package main

import (
	"flag"
	"fmt"
	"os"
	"runtime/pprof"
	"time"
)

ä¸€æ®µæœ‰é—®é¢˜çš„ä»£ç 
func logicCode() {
	var c chan int
	for {
		select {
		case v := <-c:
			fmt.Printf("recv from chan, value:%v\n", v)
		default:
			nothing to do
		}
	}
}

func main() {
	var isCPUPprof bool
	var isMemPprof bool

	flag.BoolVar(&isCPUPprof, "cpu", false, "turn cpu pprof on")
	flag.BoolVar(&isMemPprof, "mem", false, "turn mem pprof on")
	flag.Parse()

	if isCPUPprof {
		file, err := os.Create("./cpu.pprof")
		if err != nil {
			fmt.Printf("create cpu pprof failed, err:%v\n", err)
			return
		}
		pprof.StartCPUProfile(file)
		defer pprof.StopCPUProfile()
	}
    é€»è¾‘å¤„ç†
	for i := 0; i < 8; i++ {
		go logicCode()
	}
    10 s åç»“æŸé‡‡é›† CPU æ•°æ®
	time.Sleep(10 * time.Second)
	if isMemPprof {
		file, err := os.Create("./mem.pprof")
		if err != nil {
			fmt.Printf("create mem pprof failed, err:%v\n", err)
			return
		}
		pprof.WriteHeapProfile(file)
		file.Close()
	}
}
```

- pprof.StartCPUProfile(file) å¼€å¯ CPU æ€§èƒ½åˆ†æ
- pprof.WriteHeapProfile(file) å¼€å¯ Mem ä½¿ç”¨åˆ†æ

è¿è¡Œåï¼Œå½“å‰ç›®å½•ä¸‹ä¼šç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼š

```bash
Sky_Lee@SkyLeeMBP Test % ls -al | grep pprof
-rw-r--r--@  1 Sky_Lee  staff       825 10 23 17:04 cpu.pprof
-rw-r--r--@  1 Sky_Lee  staff       155 10 23 17:04 mem.pprof
```

### æœåŠ¡å‹

æœåŠ¡å‹åº”ç”¨å¯ä»¥ä½¿ç”¨ `runtime/pprof` é‡‡é›†æ•°æ®ï¼Œå¦‚æœä½¿ç”¨ gin æ¡†æ¶ï¼Œå¯ä»¥ä½¿ç”¨ github.com/gin-contrib/pprof æ¥é‡‡é›†æ•°æ®ï¼š

```go
package main

import (
	"github.com/gin-contrib/pprof"
	"github.com/gin-gonic/gin"
)

func main()  {
	r := gin.Default()
	pprof.Register(r) æ³¨å†Œ pprof ç›¸å…³è·¯ç”±
	r.GET("/", func(ctx *gin.Context) {
		ctx.String(200, "hello")
	})
	r.Run(":1145")
}
```

## go tool pprof

go tool pprof æ˜¯ç”¨æ¥åˆ†æé‡‡é›†çš„æ•°æ®çš„

### å‘½ä»¤è¡Œ

```bash
go tool pprof [binary] [source]
```

- binary æ˜¯åº”ç”¨çš„äºŒè¿›åˆ¶æ–‡ä»¶
- source æ˜¯é‡‡é›†æ•°æ®æ¥æº

å¯¹äºä¸Šé¢å·¥å…·å‹çš„ä¾‹å­ï¼Œå¯ä»¥è¿™æ ·åˆ†æï¼š

![](2023-10-23-17-25-01.png)

æ›´å¤šå‘½ä»¤ï¼Œä½¿ç”¨ help æŸ¥çœ‹

### å›¾å½¢åŒ–

å‘½ä»¤è¡Œä¸æ˜¯å¾ˆå¥½åˆ†æï¼Œå¯ä»¥ä½¿ç”¨å›¾å½¢åŒ–å·¥å…·

åœ¨ä½¿ç”¨å‰ï¼Œéœ€è¦å®‰è£… graphviz å·¥å…·

```bash
brew install graphviz
```

ç„¶åä½¿ç”¨ go tool pprofï¼Œè¾“å…¥ web å‘½ä»¤ï¼š

```bash
Sky_Lee@SkyLeeMacBook-Pro Test % go tool pprof cpu.pprof 
Type: cpu
Time: Oct 23, 2023 at 5:04pm (CST)
Duration: 10.15s, Total samples = 48.97s (482.37%)
Entering interactive mode (type "help" for commands, "o" for options)
(pprof) web
(pprof) 
```

æ­¤æ—¶ä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼š

![](2023-10-24-08-48-29.png)

## go-torch å’Œç«ç„°å›¾

> ç«ç„°å›¾ï¼ˆFlame Graphï¼‰æ˜¯ Bredan Gregg åˆ›å»ºçš„ä¸€ç§æ€§èƒ½åˆ†æå›¾è¡¨ï¼Œå› ä¸ºå®ƒçš„æ ·å­è¿‘ä¼¼ ğŸ”¥ è€Œå¾—åã€‚ä¸Šé¢çš„ profiling ç»“æœä¹Ÿè½¬æ¢æˆç«ç„°å›¾ï¼Œå¦‚æœå¯¹ç«ç„°å›¾æ¯”è¾ƒäº†è§£å¯ä»¥æ‰‹åŠ¨æ¥æ“ä½œã€‚
> go-torch æ˜¯ uber å¼€æºçš„ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥ç›´æ¥è¯»å– golang profiling æ•°æ®ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªç«ç„°å›¾çš„ svg æ–‡ä»¶ã€‚

### å®‰è£…

```bash
go install github.com/uber/go-torch@latest
```

è¦ç”Ÿæˆç«ç„°å›¾ï¼Œè¿˜éœ€è¦ FlameGraph å·¥å…·ï¼š

```bash
git clone https://github.com/brendangregg/FlameGraph.git
```

ç„¶åå°† FlameGraph å·¥å…·çš„ç›®å½•æ·»åŠ åˆ°ç¯å¢ƒå˜é‡

```bash
vim ~/.zshrc

export PATH=$PATH:/Users/Sky_Lee/Downloads/UsefulTools/FlameGraph
```

### ä½¿ç”¨

go-torch é»˜è®¤å°è¯•ä» http://localhost:8080/debug/pprof/profile è·å– profiling æ•°æ®ã€‚å®ƒæœ‰ä¸‰ä¸ªå¸¸ç”¨çš„å‚æ•°å¯ä»¥è°ƒæ•´ï¼š

- -u â€“urlï¼šè¦è®¿é—®çš„ URLï¼Œè¿™é‡Œåªæ˜¯ä¸»æœºå’Œç«¯å£éƒ¨åˆ†
- -s â€“suffixï¼špprof profile çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º /debug/pprof/profile
- â€“secondsï¼šè¦æ‰§è¡Œ profiling çš„æ—¶é—´é•¿åº¦ï¼Œé»˜è®¤ä¸º 30s

ä¾‹å¦‚ï¼Œå¯¹ä¸Šé¢çš„ helloweb demo è¿›è¡Œå‹æµ‹çš„åŒæ—¶é‡‡é›†æ•°æ®ï¼š

```bash
Sky_Lee@SkyLeeMacBook-Pro Test % go-torch -u http://127.0.0.1:1145 -t 30

INFO[08:42:39] Run pprof command: go tool pprof -raw -seconds 30 http://127.0.0.1:1145/debug/pprof/profile
INFO[08:43:10] Writing svg to torch.svg
```

30s ååœ¨å½“å‰ç›®å½•ç”Ÿæˆ svg æ–‡ä»¶ï¼Œä½¿ç”¨æµè§ˆå™¨æ‰“å¼€å³å¯

![](2023-10-24-08-46-19.png)

- y è½´ä»£è¡¨ cpu è°ƒç”¨æ–¹æ³•çš„é¡ºåº
- x è½´ä»£è¡¨å•ä½é‡‡æ ·æ—¶é—´å†…ï¼Œæ–¹æ³•æ‰€å çš„æ—¶é—´çš„ç™¾åˆ†æ¯”ï¼Œè¶Šå®½ï¼Œè¯´æ˜å ç”¨çš„ CPU è¶Šå¤š

è¿˜å¯ä»¥ä½¿ç”¨ go-torch åˆ†æå†…å­˜æ•°æ®ï¼š

```bash
go-torch -inuse_space http://127.0.0.1:8080/debug/pprof/heap
go-torch -inuse_objects http://127.0.0.1:8080/debug/pprof/heap
go-torch -alloc_space http://127.0.0.1:8080/debug/pprof/heap
go-torch -alloc_objects http://127.0.0.1:8080/debug/pprof/heap
```

# Docker

Docker æ˜¯ä¸€ç§å¼€æºçš„ **å®¹å™¨åŒ–** å¹³å°ï¼Œç”¨äºè½»æ¾åœ°åˆ›å»ºã€éƒ¨ç½²å’Œç®¡ç†åº”ç”¨ç¨‹åºã€‚

å®¹å™¨åŒ–æ˜¯ä¸€ç§è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå®ƒå…è®¸æ‚¨ **å°†åº”ç”¨ç¨‹åºåŠå…¶æ‰€æœ‰ä¾èµ–é¡¹æ‰“åŒ…æˆä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨** ï¼Œä»¥ç¡®ä¿åœ¨ä¸åŒç¯å¢ƒä¸­çš„ **å¯ç§»æ¤æ€§** å’Œ **ä¸€è‡´æ€§** ã€‚

**æ³¨æ„ï¼šDocker ä¸ç­‰äºå®¹å™¨ï¼Œåªæ˜¯å®¹å™¨çš„ä¸€ç§å®ç°**

## ä¸è™šæ‹Ÿæœºçš„åŒºåˆ«

- Docker **å…±äº«å®¿ä¸»æ“ä½œç³»ç»Ÿçš„å†…æ ¸**ï¼Œè€Œè™šæ‹ŸæœºåŒ…å«ä¸€ä¸ªç‹¬ç«‹çš„å†…æ ¸
- Docker å®¹å™¨å ç”¨æ›´å°‘çš„å†…å­˜å’Œå­˜å‚¨ç©ºé—´

> ![](2023-10-24-19-09-23.png)
> ![](2023-10-24-19-09-44.png)

## åŸºæœ¬åŸç†å’Œæ¦‚å¿µ

Docker æœ€åŸºæœ¬ã€æœ€é‡è¦çš„æ¦‚å¿µå°±æ˜¯ **é•œåƒ**ã€**å®¹å™¨**

> Docker é•œåƒ **åŒ…å«äº†ä¸€ä¸ªåº”ç”¨ç¨‹åºåŠå…¶æ‰€æœ‰ä¾èµ–é¡¹çš„æ–‡ä»¶ç³»ç»Ÿ** ã€‚å®ƒæ˜¯ä¸€ä¸ª **åªè¯»** çš„æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„ï¼Œå¯ä»¥ç”¨äºåˆ›å»º Docker å®¹å™¨çš„è¿è¡Œå®ä¾‹ã€‚ä¸€ä¸ª Docker é•œåƒé€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªä¸»è¦éƒ¨åˆ†ï¼š
> 
> 1. **æ–‡ä»¶ç³»ç»Ÿ**ï¼šé•œåƒåŒ…å«äº†åº”ç”¨ç¨‹åºçš„æ–‡ä»¶ç³»ç»Ÿï¼ŒåŒ…æ‹¬å¯æ‰§è¡Œæ–‡ä»¶ã€åº“ã€é…ç½®æ–‡ä»¶ã€é™æ€èµ„æºç­‰ã€‚è¿™æ˜¯åº”ç”¨ç¨‹åºçš„å®é™…å†…å®¹ã€‚
> 
> 2. **å…ƒæ•°æ®**ï¼šé•œåƒè¿˜åŒ…æ‹¬å…³äºé•œåƒæœ¬èº«çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¦‚é•œåƒçš„åç§°ã€æ ‡ç­¾ã€ä½œè€…ã€æè¿°ã€åˆ›å»ºæ—¶é—´ç­‰ã€‚è¿™äº›ä¿¡æ¯ç”¨äºæ ‡è¯†å’Œæè¿°é•œåƒã€‚
> 
> 3. **è¿è¡Œæ—¶é…ç½®**ï¼šDocker é•œåƒå¯ä»¥åŒ…å«è¿è¡Œæ—¶é…ç½®ï¼Œå¦‚ç¯å¢ƒå˜é‡ã€å‘½ä»¤ç­‰ï¼Œè¿™äº›é…ç½®ä¼šåœ¨å®¹å™¨å¯åŠ¨æ—¶è¢«åº”ç”¨ã€‚
> 
> 4. **ä¾èµ–é¡¹**ï¼šé•œåƒå¯èƒ½åŒ…å«åº”ç”¨ç¨‹åºæ‰€éœ€çš„å„ç§ä¾èµ–é¡¹ï¼Œå¦‚åº“æ–‡ä»¶ã€è¿è¡Œæ—¶ç¯å¢ƒã€æ“ä½œç³»ç»Ÿç»„ä»¶ç­‰ã€‚è¿™äº›ä¾èµ–é¡¹é€šå¸¸ä¼šä½œä¸ºæ–‡ä»¶ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†å­˜åœ¨ã€‚
> 
> 5. **åˆ†å±‚ç»“æ„**ï¼šDocker é•œåƒæ˜¯åˆ†å±‚çš„ï¼Œæ¯ä¸ªå±‚éƒ½ä»£è¡¨äº†æ–‡ä»¶ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚è¿™ä½¿å¾—é•œåƒå¯ä»¥è¢«æœ‰æ•ˆåœ°å…±äº«å’Œé‡ç”¨ï¼Œå› ä¸ºå¤šä¸ªé•œåƒå¯ä»¥å…±äº«ç›¸åŒçš„å±‚ã€‚å½“æ‚¨æ„å»ºæ–°çš„é•œåƒæ—¶ï¼Œåªéœ€æ·»åŠ æˆ–ä¿®æ”¹å¿…è¦çš„å±‚ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚
> 
> é•œåƒæ˜¯ Docker å®¹å™¨çš„æ„å»ºå—ï¼Œå®¹å™¨æ˜¯ä»é•œåƒä¸­åˆ›å»ºçš„è¿è¡Œå®ä¾‹ã€‚å½“è¿è¡Œä¸€ä¸ªå®¹å™¨æ—¶ï¼Œå®ƒä¼šç»§æ‰¿é•œåƒçš„æ–‡ä»¶ç³»ç»Ÿã€å…ƒæ•°æ®å’Œé…ç½®ï¼Œå¹¶å¯ä»¥è¿›è¡Œä¿®æ”¹ã€‚å®¹å™¨å¯ä»¥è¯»å†™è‡ªå·±çš„æ–‡ä»¶ç³»ç»Ÿå±‚ï¼Œå…è®¸åº”ç”¨ç¨‹åºè¿è¡Œå’Œå­˜å‚¨æ•°æ®ã€‚è¿™ç§åˆ†å±‚çš„ç»“æ„å’Œé•œåƒçš„åªè¯»ç‰¹æ€§ä½¿å®¹å™¨å¯ä»¥è½»æ¾å…±äº«å’Œåˆ†å‘ï¼ŒåŒæ—¶ä¿æŒä¸€è‡´æ€§å’Œå¯ç§»æ¤æ€§ã€‚

ç®€å•çš„ç†è§£ï¼š

é•œåƒå°±æ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼ŒåŒ…å«äº†ä¸€ä¸ªåº”ç”¨ç¨‹åºåŠå…¶æ‰€æœ‰ä¾èµ–é¡¹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œå®¹å™¨æ˜¯é•œåƒçš„ä¸€ä¸ªå®ä¾‹ï¼Œä¸€ä¸ªé•œåƒå¯ä»¥æœ‰å¤šä¸ªå®ä¾‹

å¯ä»¥è¿™æ ·æ¯”å–»ï¼š

é•œåƒå°±åƒ Java ä¸­çš„ç±»ï¼Œæœ‰è‡ªå·±çš„å±æ€§å’Œæ–¹æ³•ï¼Œå®¹å™¨å°±åƒç±»çš„å®ä¾‹ï¼Œä¸€ä¸ªé•œåƒå¯ä»¥æœ‰å¤šä¸ªå®ä¾‹

## å®‰è£… Docker

å¯ä»¥åœ¨ [è¿™ä¸ªç½‘ç«™](https://docs.docker.com/get-docker/) è·å– docker çš„æ¡Œé¢ç«¯

å®‰è£…åï¼Œéœ€è¦å¯åŠ¨ dockerï¼Œç„¶åæ‰èƒ½ä½¿ç”¨ docker ç›¸å…³å‘½ä»¤

![](2023-10-24-19-37-20.png)

å¦‚æœçœ‹ä¸åˆ° Serverï¼Œè¯´æ˜æ²¡æœ‰å¯åŠ¨ docker æœåŠ¡

å¦‚æœè¦åœ¨ Linux æœåŠ¡å™¨ä¸Šå®‰è£… dockerï¼Œå¯ä»¥æŸ¥çœ‹ [å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/engine/install/centos/)

## å®¹å™¨åŒ–ä¸ Dockerfile

è¿è¡Œä¸€ä¸ªå®¹å™¨å¤§è‡´åˆ†ä¸ºä»¥ä¸‹ä¸‰æ­¥ï¼š

- ç¼–å†™ Dockerfile
- ä½¿ç”¨ Dockerfile åˆ›å»ºé•œåƒ
- ä½¿ç”¨é•œåƒåˆ›å»ºå®¹å™¨
- è¿è¡Œå®¹å™¨

> Dockerfile æ˜¯ç”¨äºæ„å»º Docker é•œåƒçš„æ–‡æœ¬æ–‡ä»¶ï¼Œå®ƒåŒ…å«äº†ä¸€ç³»åˆ—æŒ‡ä»¤å’Œå‚æ•°ï¼Œæè¿°äº†å¦‚ä½•åˆ›å»º Docker é•œåƒçš„è¿‡ç¨‹ã€‚é€šè¿‡ç¼–å†™ Dockerfileï¼Œå¯ä»¥å®šä¹‰åº”ç”¨ç¨‹åºçš„ **ç¯å¢ƒå’Œä¾èµ–é¡¹**ï¼Œä»¥ä¾¿ Docker å¯ä»¥æ ¹æ®è¿™äº›æŒ‡ä»¤è‡ªåŠ¨æ„å»ºé•œåƒã€‚


## ç¤ºä¾‹

ä¸‹é¢é€šè¿‡ä¸€ä¸ªç®€å•çš„ hello-docker demo æ¥æ¼”ç¤º docker çš„åŸºæœ¬ä½¿ç”¨

### åˆ›å»ºé¡¹ç›®

é¦–å…ˆï¼Œåœ¨å¼€å‘ç¯å¢ƒåˆ›å»ºä¸€ä¸ª hello-docker é¡¹ç›®

ç„¶åï¼Œç¼–å†™ main.go:

```go
package main

import (
	"net/http"

	"github.com/gin-gonic/gin"
)

func main()  {
	r := gin.Default()
	r.GET("/", func(ctx *gin.Context) {
		ctx.String(http.StatusOK, "hello, docker!")
	})
	r.Run(":1145")
}
```

### åˆ¶ä½œé•œåƒ

ç°åœ¨ï¼Œé¡¹ç›®ç¼–å†™å®Œæ¯•ï¼Œå¼€å§‹åˆ¶ä½œé•œåƒ

åˆ¶ä½œé•œåƒï¼Œéœ€è¦ç¼–å†™ Dockerfile

```bash
touch Dockerfile
```

æ³¨æ„ï¼šåˆ›å»º Dockerfile æ—¶ï¼Œæ²¡æœ‰åç¼€åï¼Œå¹¶ä¸”åº”è¯¥éµå®ˆå‘½åè§„èŒƒ

å†…å®¹å¦‚ä¸‹ï¼š

```dockerfile
FROM golang:alpine

# ç§»åŠ¨åˆ°å·¥ä½œç›®å½•ï¼š/build
WORKDIR /build

# å¤åˆ¶é¡¹ç›®ä¸­çš„ go.mod å’Œ go.sumæ–‡ä»¶å¹¶ä¸‹è½½ä¾èµ–ä¿¡æ¯
COPY go.mod .
COPY go.sum .
RUN go mod download

# å°†ä»£ç å¤åˆ¶åˆ°å®¹å™¨ä¸­
COPY . .

# å°†æˆ‘ä»¬çš„ä»£ç ç¼–è¯‘æˆäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
RUN go build

# å£°æ˜æœåŠ¡ç›‘å¬ç«¯å£
EXPOSE 1145

# è¿è¡Œå®¹å™¨
CMD [ "./hello-docker" ]
```

ç„¶ååœ¨ç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
docker build -t hello-docker .
```

è¿™å°†åœ¨å½“å‰ç›®å½•ä¸‹æœç´¢ Dockerfileï¼Œå¹¶åˆ›å»ºä¸€ä¸ª docker é•œåƒ

![](2023-10-24-20-17-57.png)

åˆ›å»ºçš„é•œåƒå¹¶ä¸ä¼šä¿å­˜åœ¨å½“å‰ç›®å½•ï¼Œä½¿ç”¨ï¼š

```bash
docker images
```

æŸ¥çœ‹å½“å‰å­˜åœ¨çš„é•œåƒï¼š

![](2023-10-24-20-20-04.png)

### è¿è¡Œå®¹å™¨

åŸºäºä¸Šé¢åˆ›å»ºçš„é•œåƒï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªå®¹å™¨ï¼Œå¹¶è¿è¡Œï¼š

```bash
docker run -p 1145:1145 hello-docker
```

è¿™é‡Œ -p é€‰é¡¹å°†å®¹å™¨çš„ 1145 ç«¯å£ç»‘å®šåˆ°äº†æœ¬æœºçš„ 1145 ç«¯å£

ç°åœ¨ï¼Œå°±å¯ä»¥åœ¨æµè§ˆå™¨è®¿é—® `localhost:1145` äº†

### ä¸Šä¼  Docker é•œåƒåˆ°æœåŠ¡å™¨

æœ¬åœ°æµ‹è¯•æ²¡é—®é¢˜ï¼Œå°±å¯ä»¥å°† Docker é•œåƒæ‰“åŒ…æˆ tar æ–‡ä»¶ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨

```bash
docker save -o hello-docker.tar hello-docker:latest
```

è¯¥å‘½ä»¤ä¼šå°† hello-docker é•œåƒæ‰“åŒ…æˆä¸€ä¸ª tar åŒ…

ä¸Šä¼ åˆ°æœåŠ¡å™¨åï¼Œåœ¨æœåŠ¡å™¨ä¸‹è¿è¡Œï¼š

```bash
docker load -i hello-docker.tar
```

è¯¥å‘½ä»¤ä¼šå¯¼å…¥ hello-docker é•œåƒ

![](2023-10-24-21-11-49.png)

**æ³¨æ„ï¼š** éœ€è¦è¶…çº§ç”¨æˆ·æƒé™æ‰§è¡Œè¯¥å‘½ä»¤

### åœ¨æœåŠ¡å™¨ä¸Šå¯åŠ¨ hello-docker é¡¹ç›®

```bash
docker run -p 1145:1145 hello-docker
```

ç°åœ¨ï¼Œæˆ‘ä»¬çš„ hello-docker é¡¹ç›®å°±æˆåŠŸéƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Šäº†

### åˆ é™¤ hello-docker é¡¹ç›®

æŸ¥çœ‹å½“å‰æ‰€æœ‰çš„ docker å®¹å™¨ï¼š

```bash
docker container ls -a 
```

åˆ é™¤ hello-docker å®¹å™¨ï¼š

```bash
docker rm <container name>
```

åˆ é™¤ hello-docker é•œåƒï¼š

```bash
docker image rm <image name>
```

## åˆ†é˜¶æ®µæ„å»º

> æˆ‘ä»¬çš„Goç¨‹åºç¼–è¯‘ä¹‹åä¼šå¾—åˆ°ä¸€ä¸ªå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…¶å®åœ¨æœ€ç»ˆçš„é•œåƒä¸­æ˜¯ä¸éœ€è¦goç¼–è¯‘å™¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªè¿è¡Œæœ€ç»ˆäºŒè¿›åˆ¶æ–‡ä»¶çš„å®¹å™¨å³å¯ã€‚
>
> Dockerçš„æœ€ä½³å®è·µä¹‹ä¸€æ˜¯é€šè¿‡ä»…ä¿ç•™äºŒè¿›åˆ¶æ–‡ä»¶æ¥å‡å°é•œåƒå¤§å°ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ç§ç§°ä¸ºå¤šé˜¶æ®µæ„å»ºçš„æŠ€æœ¯ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å°†é€šè¿‡å¤šä¸ªæ­¥éª¤æ„å»ºé•œåƒã€‚

```dockerfile
FROM golang:alpine AS builder

# ç§»åŠ¨åˆ°å·¥ä½œç›®å½•ï¼š/build
WORKDIR /build

# å¤åˆ¶é¡¹ç›®ä¸­çš„ go.mod å’Œ go.sumæ–‡ä»¶å¹¶ä¸‹è½½ä¾èµ–ä¿¡æ¯
COPY go.mod .
COPY go.sum .
RUN go mod download

# å°†ä»£ç å¤åˆ¶åˆ°å®¹å™¨ä¸­
COPY . .

# å°†æˆ‘ä»¬çš„ä»£ç ç¼–è¯‘æˆäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
RUN go build

# å£°æ˜æœåŠ¡ç«¯å£
EXPOSE 1145



# åˆ›å»ºä¸€ä¸ªå°çš„é•œåƒ #
FROM scratch

COPY --from=builder /build/hello-docker /

ENTRYPOINT [ "/hello-docker" ]
```

![](2023-10-25-11-49-18.png)

ç”Ÿæˆçš„é•œåƒå¤§å°ä»… 10.4 MBï¼Œéå¸¸å°

> scratch æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ç©ºç™½é•œåƒï¼Œå®ƒæ˜¯æœ€å°çš„åŸºç¡€é•œåƒï¼Œæ²¡æœ‰ä»»ä½•æ“ä½œç³»ç»Ÿæˆ–æ–‡ä»¶ç³»ç»Ÿã€‚é€šå¸¸ç”¨äºæ„å»ºé™æ€äºŒè¿›åˆ¶æ–‡ä»¶çš„ Docker é•œåƒã€‚

## Docker Compose

Docker Compose æ˜¯ä¸€ä¸ªç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šä¸ª Docker å®¹å™¨çš„å·¥å…·ï¼Œä»¥ä¾¿ååŒè¿è¡Œå¤æ‚çš„å¤šå®¹å™¨åº”ç”¨ç¨‹åºã€‚

ä¾‹å¦‚ï¼Œä¸€ä¸ª Web ç¨‹åºé‡‡å–å‰åç«¯åˆ†ç¦»çš„æ¶æ„ï¼Œå‰ç«¯ã€åç«¯ã€æ•°æ®åº“ã€ç¼“å­˜ã€è´Ÿè½½å‡è¡¡ éƒ½æœ‰ä¸€ä¸ªå®¹å™¨ï¼Œè¿™äº›å®¹å™¨ä¹‹é—´å…·æœ‰ä¾èµ–å…³ç³»ï¼Œä½¿ç”¨ Docker Compose å°±å¯ä»¥å¿«é€Ÿå¯åŠ¨ Web é¡¹ç›®

Docker Compose ä½¿ç”¨ docker-compose.yml é…ç½®æ–‡ä»¶æè¿°æ•´ä¸ªåº”ç”¨ç¨‹åºçš„æ¶æ„

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹çš„ `docker-compose.yml` æ–‡ä»¶ï¼Œç”¨äºå¯åŠ¨ä¸€ä¸ªå‰åç«¯åˆ†ç¦»çš„ Web é¡¹ç›®ï¼Œåç«¯è¿æ¥ MySQL å’Œ Redisã€‚è¯¥ç¤ºä¾‹ä½¿ç”¨äº†å››ä¸ªæœåŠ¡ï¼šå‰ç«¯ã€åç«¯ã€MySQL å’Œ Redisã€‚

```yaml
version: '3'
services:
  frontend:
    image: your-frontend-image:tag
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - webnet

  backend:
    image: your-backend-image:tag
    environment:
      MYSQL_HOST: mysql
      REDIS_HOST: redis
    networks:
      - webnet
    links:
      - mysql
      - redis

  mysql:
    image: mysql:latest
    environment:
      MYSQL_ROOT_PASSWORD: your-root-password
      MYSQL_DATABASE: your-database-name
    networks:
      - webnet

  redis:
    image: redis:latest
    networks:
      - webnet

networks:
  webnet:
```

- `frontend` æœåŠ¡ä»£è¡¨å‰ç«¯åº”ç”¨ç¨‹åºã€‚æ‚¨éœ€è¦å°† `your-frontend-image:tag` æ›¿æ¢ä¸ºæ‚¨çš„å‰ç«¯åº”ç”¨ç¨‹åºçš„ Docker é•œåƒã€‚
- `backend` æœåŠ¡ä»£è¡¨åç«¯åº”ç”¨ç¨‹åºã€‚æ‚¨éœ€è¦å°† `your-backend-image:tag` æ›¿æ¢ä¸ºæ‚¨çš„åç«¯åº”ç”¨ç¨‹åºçš„ Docker é•œåƒã€‚åœ¨ `environment` éƒ¨åˆ†è®¾ç½®äº† MySQL å’Œ Redis çš„è¿æ¥ä¿¡æ¯ã€‚
- `mysql` æœåŠ¡ä½¿ç”¨äº† MySQL å®˜æ–¹é•œåƒï¼Œå¹¶é…ç½®äº†æ ¹å¯†ç å’Œæ•°æ®åº“åç§°ã€‚æ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹è¿™äº›ç¯å¢ƒå˜é‡ã€‚
- `redis` æœåŠ¡ä½¿ç”¨äº†å®˜æ–¹ Redis é•œåƒã€‚
- `ports` æŒ‡å®šäº†å‰ç«¯æœåŠ¡åœ¨ä¸»æœºä¸Šçš„ç«¯å£æ˜ å°„ï¼Œè¿™é‡Œæ˜ å°„åˆ°ä¸»æœºçš„ç«¯å£ 80ã€‚
- `depends_on` æŒ‡å®šäº† `frontend` æœåŠ¡ä¾èµ–äº `backend` æœåŠ¡ï¼Œç¡®ä¿åç«¯åº”ç”¨ç¨‹åºå¯åŠ¨åå‰ç«¯åº”ç”¨ç¨‹åºæ‰èƒ½å¯åŠ¨ã€‚
- `links` ç”¨äºå°† `mysql` å’Œ `redis` æœåŠ¡é“¾æ¥åˆ° `backend` æœåŠ¡ï¼Œä»¥ä¾¿åç«¯åº”ç”¨ç¨‹åºèƒ½å¤Ÿè®¿é—®è¿™ä¸¤ä¸ªæœåŠ¡ã€‚
- `networks` éƒ¨åˆ†å®šä¹‰äº†ä¸€ä¸ªåä¸º `webnet` çš„è‡ªå®šä¹‰ç½‘ç»œï¼Œç”¨äºè¿æ¥æ‰€æœ‰æœåŠ¡ã€‚

## å¸¸ç”¨ docker å‘½ä»¤

![](2023-10-24-21-24-54.png)

![](2023-10-24-21-25-10.png)

# æœç´¢

æƒ³æä¾›ä¸€ä¸ªæ¥å£ï¼š

```go
v1.GET("/post/search", controller.PostSearchHandler)
```

è¯¥æ¥å£æ ¹æ®ç”¨æˆ·ä¼ è¿›çš„å…³é”®è¯ï¼Œåœ¨å¸–å­çš„ï¼š

- æ ‡é¢˜
- æ­£æ–‡

ä¸­å»æœç´¢

ä½†æ˜¯é‡åˆ°äº†éš¾é¢˜ï¼š

1. æ ‡é¢˜æ¨¡ç³ŠæŸ¥è¯¢å¦‚ä½•å®ç°ï¼Ÿ
2. æ€ä¹ˆå»ºç«‹ç´¢å¼•ï¼Ÿ
3. å…¨æ–‡æ¨¡ç³ŠæŸ¥è¯¢å¦‚ä½•å®ç°ï¼Ÿ
4. æ€ä¹ˆä½¿ç”¨ç¼“å­˜åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ï¼Ÿ

å¯¹äº tilteï¼Œå¦‚æœç›´æ¥åœ¨ MySQL ä¸­æ¨¡ç³ŠæŸ¥è¯¢ï¼š

```go
func DemoSelectPostIDsByTitleKeyword(pageNum, pageSize int64, keyword string) ([]string, error) {
	sqlStr := "SELECT post_id FROM posts WHERE title LIKE ? LIMIT ?, ?"
	key := "%" + keyword + "%" // title ç´¢å¼•å¤±æ•ˆ
	start := (pageNum - 1) * pageSize

	postIDs := make([]string, 0)
	res := db.Raw(sqlStr, key, start, pageSize).Scan(&postIDs)
	if res.Error != nil {
		return nil, errors.Wrap(res.Error, "get post_ids by keyword")
	}

	return postIDs, nil
}
```

å¯¹äº title å»ºç«‹çš„ç´¢å¼•ä¼šå¤±æ•ˆï¼ŒåŸå› ï¼š

- å¤´éƒ¨æ¨¡ç³ŠæŸ¥è¯¢
- å°±ç®—ä¸ç”¨å¤´éƒ¨æ¨¡ç³ŠæŸ¥è¯¢ï¼Œä¾‹å¦‚ `where title like 'tit%'`ï¼Œå¦‚æœè¡¨ä¸­å­˜åœ¨å¤§é‡ä»¥ `tit` å¼€å¤´çš„æ ‡é¢˜ï¼Œç´¢å¼•ä¹Ÿä¸ä¼šç”Ÿæ•ˆï¼ˆä¸èµ°ç´¢å¼•æ›´å¿«ï¼‰

äºæ˜¯æŸ¥çœ‹ä¹‹å‰çš„ç¬”è®°ï¼Œå‘ç°ä¼¼ä¹ MySQL çš„ **å…¨æ–‡ç´¢å¼•** å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜

å¯¹ title å’Œ content å­—æ®µå»ºç«‹å…¨æ–‡ç´¢å¼•ï¼š

```sql
create fulltext index idx_title on posts(title);
create fulltext index idx_content on posts(content(512)); -- å‰ç¼€ç´¢å¼•
```

æŸ¥è¯¢çš„ SQL è¯­å¥ï¼š

```sql
explain
select post_id, title from posts where MATCH(title) AGAINST('simple');

explain
select post_id from posts where MATCH(content) AGAINST('docker');
```

ä½†æ˜¯è¿™ç§æ–¹å¼å¯¹ä¸­æ–‡æ”¯æŒä¸å¤ªå¥½ï¼Œä¾‹å¦‚æœ‰ä¸¤ç¯‡å¸–å­ï¼Œæ ‡é¢˜å’Œå†…å®¹å¦‚ä¸‹ï¼š

```
+----+------------------+--------------+------------------+--------+--------------------------+---------------------+---------------------+---------------------+
| id | post_id          | community_id | author_id        | status | title                    | content             | created_at          | updated_at          |
+----+------------------+--------------+------------------+--------+--------------------------+---------------------+---------------------+---------------------+
| 84 | 6594082939867136 |            2 | 4488717146263552 |      1 | æµ‹è¯•å¯¹ä¸­æ–‡çš„æ”¯æŒ            | å°±åƒæ ‡é¢˜ä¸€æ ·          | 2023-11-01 15:04:51 | 2023-11-01 15:05:02 |
| 85 | 6595071927390208 |            2 | 4488717146263552 |      1 | Test support for English | just like the title | 2023-11-01 15:08:47 | 2023-11-01 15:08:57 |
+----+------------------+--------------+------------------+--------+--------------------------+---------------------+---------------------+---------------------+
```

```sql
select post_id from posts where MATCH(title) AGAINST('ä¸­æ–‡'); -- failed

select post_id from posts where MATCH(content) AGAINST('æ ‡é¢˜'); -- failed

select post_id from posts where MATCH(title) AGAINST('english'); -- success

select post_id from posts where MATCH(content) AGAINST('title'); -- success
```